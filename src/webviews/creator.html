<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>RPLC Configurator</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="preset-selector">
            <h2>Select RPLC Model</h2>
            <select id="RPLC_List">
                <option value="">-- Select --</option>
                <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </select>

            <div class="or-divider">
                <span>OR</span>
            </div>

            <div class="new-config-section">
                <h3>Create New Configuration</h3>
                <div class="new-config-form">
                    <div class="form-group">
                        <label for="newConfigName">Configuration Name:</label>
                        <input type="text" id="newConfigName" placeholder="MY_CUSTOM_RPLC" />
                    </div>
                    <div class="form-group">
                        <label for="newConfigMemory">Memory (KB):</label>
                        <input type="number" id="newConfigMemory" value="512" min="256" max="4096" />
                    </div>
                    <button id="createNewButton" class="create-btn">Create New Configuration</button>
                </div>
            </div>

            <div id="dynamicOptions">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–ø—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
            </div>
        </div>

        <div class="preset-view" id="presetView">
            <h2>Configuration Preview</h2>
            <div id="presetContent">
                <p>Please select an RPLC model</p>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö RPLC
        function populateRPLCList(presets) {
            const select = document.getElementById('RPLC_List');
            select.innerHTML = '<option value="">-- Select --</option>';
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.name;
                option.textContent = preset.name;
                select.appendChild(option);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
        document.getElementById('RPLC_List').addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            if (selectedValue) {
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
                clearNewConfigForm();
                
                vscode.postMessage({
                    command: 'rplcListChanged',
                    value: selectedValue
                });
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
        document.getElementById('createNewButton').addEventListener('click', () => {
            const name = document.getElementById('newConfigName').value.trim();
            const memory = parseInt(document.getElementById('newConfigMemory').value);

            if (!name) {
                alert('Please enter a configuration name');
                return;
            }

            if (!memory || memory < 256) {
                alert('Please enter a valid memory size (minimum 256 KB)');
                return;
            }

            // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
            document.getElementById('RPLC_List').value = '';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
            vscode.postMessage({
                command: 'createNewConfig',
                name: name,
                memory: memory
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
        function clearNewConfigForm() {
            document.getElementById('newConfigName').value = '';
            document.getElementById('newConfigMemory').value = '512';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞
        function updatePresetDisplay(preset) {
            const presetContent = document.getElementById('presetContent');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const createInputForValue = (key, value) => {
                const type = typeof value;
                
                if (type === 'boolean') {
                    return `
                        <select class="config-input" data-key="${key}">
                            <option value="true" ${value === true ? 'selected' : ''}>true</option>
                            <option value="false" ${value === false ? 'selected' : ''}>false</option>
                        </select>
                    `;
                } else if (type === 'number') {
                    return `<input type="number" class="config-input" data-key="${key}" value="${value}">`;
                } else {
                    return `<input type="text" class="config-input" data-key="${key}" value="${value}">`;
                }
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            const createConfigControls = (config, prefix = '') => {
                let controls = '';
                
                for (const [key, value] of Object.entries(config)) {
                    if (key === 'name' || key === 'compileDefinition') {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–∏ –ø–æ–ª—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                        continue;
                    }
                    
                    const fullKey = prefix ? `${prefix}.${key}` : key;
                    
                    if (value !== null && typeof value === 'object') {
                        controls += `
                            <div class="config-group">
                                <h4>${key.toUpperCase()}</h4>
                                ${createConfigControls(value, fullKey)}
                            </div>
                        `;
                    } else {
                        controls += `
                            <div class="config-item">
                                <label>${key}:</label>
                                ${createInputForValue(fullKey, value)}
                            </div>
                        `;
                    }
                }
                
                return controls;
            };

            const isNewConfig = preset.name === 'RPLC_TEMPLATE' || !preset.name.startsWith('RPLC_');
            
            let html = `
                <div class="preset">
                    <h3>${isNewConfig ? 'New Configuration' : preset.name}</h3>
                    <div class="config-item">
                        <label>Name:</label>
                        <input type="text" class="config-input" data-key="name" value="${preset.name}">
                    </div>
                    <div class="config-item">
                        <label>Memory (KB):</label>
                        <input type="number" class="config-input" data-key="memory" value="${preset.memory}" min="256" max="4096">
                    </div>
                    <div class="config-item">
                        <label>Compile Definition:</label>
                        <input type="text" class="config-input" data-key="compileDefinition" value="${preset.compileDefinition}">
                    </div>
                    
                    <div class="config-section">
                        <h4>Configuration Options</h4>
                        ${createConfigControls(preset)}
                        ${isNewConfig ? '<p class="hint">üí° <strong>Tip:</strong> Set options to <code>true</code> to enable them, or remove unused fields entirely from the final JSON.</p>' : ''}
                    </div>
                    
                    <button class="save-btn">Save Configuration</button>
                </div>
            `;

            presetContent.innerHTML = html;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            presetContent.querySelector('.save-btn').addEventListener('click', () => {
                const inputs = presetContent.querySelectorAll('.config-input');
                const updatedConfig = {...preset};
                
                inputs.forEach(input => {
                    const keys = input.dataset.key.split('.');
                    let current = updatedConfig;
                    
                    for (let i = 0; i < keys.length - 1; i++) {
                        current = current[keys[i]];
                    }
                    
                    const lastKey = keys[keys.length - 1];
                    current[lastKey] = input.type === 'select-one' 
                        ? input.value === 'true' 
                        : typeof current[lastKey] === 'number' 
                            ? Number(input.value) 
                            : input.value;
                });
                
                console.log('Updated config:', updatedConfig);
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.command) {
                case 'initialize':
                    populateRPLCList(message.presets);
                    break;

                case 'updatePresetView':
                    updatePresetDisplay(message.preset);
                    // updateDynamicOptions(message.preset);
                    break;
            }
        });

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        vscode.postMessage({ command: 'getInitialData' });
    </script>
</body>

</html>